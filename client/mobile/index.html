<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#141218" />
  <title>ğŸ¥§ Vibe Cod'in Pie â€” å‚ä¸äº’åŠ¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Google+Sans+Text:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet" />
  <style>
    /* â”€â”€ M3 Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .md-tabs {
      display: flex; background: rgba(20, 18, 24, 0.85);
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      position: sticky; top: 0; z-index: 20;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding-top: env(safe-area-inset-top);
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }
    .md-tab {
      flex: 1; height: 48px;
      background: transparent; border: none;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-family: var(--md-sys-typescale-title-font);
      font-size: 14px; font-weight: 500;
      color: var(--md-sys-color-on-surface-variant);
      position: relative; cursor: pointer;
      touch-action: manipulation;
    }
    .md-tab.active {
      color: var(--md-sys-color-primary);
    }
    .md-tab-indicator {
      position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
      background: var(--md-sys-color-primary);
      border-radius: 3px 3px 0 0;
      transform: scaleX(0); transition: transform 0.2s;
    }
    .md-tab.active .md-tab-indicator {
      transform: scaleX(1); /* simplified, usually needs width calc */
      width: 50%; left: 25%;
    }
    .md-tab-icon { font-size: 20px; margin-bottom: 2px; }

    /* â”€â”€ Slider Control UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #slider-section {
      display: none; /* Hidden by default */
      flex-direction: column; gap: 24px;
      align-items: center; justify-content: center;
      padding: 32px 16px;
      text-align: center;
      min-height: 300px;
    }
    .slider-card-container {
      width: 100%; overflow-x: auto;
      display: flex; scroll-snap-type: x mandatory;
      gap: 16px; padding-bottom: 20px;
      -webkit-overflow-scrolling: touch;
    }
    .slider-card {
      flex: 0 0 100%; scroll-snap-align: center;
      background: var(--md-sys-color-surface-container);
      border-radius: var(--md-sys-shape-corner-large);
      padding: 24px;
      display: flex; flex-direction: column; align-items: center; gap: 16px;
      box-shadow: var(--md-sys-elevation-1);
      transition: transform 0.2s;
    }
    .slider-card.active-control {
      border: 2px solid var(--md-sys-color-primary);
      box-shadow: var(--md-sys-elevation-2);
    }
    .slider-name {
      font-family: var(--md-sys-typescale-title-font);
      font-size: 18px; color: var(--md-sys-color-on-surface);
    }
    .slider-value-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 24px; color: var(--md-sys-color-primary);
    }
    
    /* Force Visualizer */
    .force-visualizer {
      width: 100%; height: 12px;
      background: var(--md-sys-color-surface-container-highest);
      border-radius: 6px; position: relative; overflow: hidden;
      margin: 16px 0;
    }
    .force-bar {
      position: absolute; top: 0; bottom: 0;
      background: var(--md-sys-color-primary);
      transition: width 0.1s linear, left 0.1s linear;
      opacity: 0.8;
    }
    .force-center-mark {
      position: absolute; left: 50%; top: 0; bottom: 0; width: 2px;
      background: var(--md-sys-color-outline); transform: translateX(-50%);
    }
    
    .control-hint {
      font-size: 12px; color: var(--md-sys-color-on-surface-variant);
      display: flex; align-items: center; gap: 6px;
    }
    .gyro-icon {
      font-size: 48px; color: var(--md-sys-color-secondary);
      animation: tilt-anim 2s infinite ease-in-out;
    }
    @keyframes tilt-anim {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-15deg); }
      75% { transform: rotate(15deg); }
    }
    
    .no-sliders-msg {
      color: var(--md-sys-color-outline);
      font-style: italic; padding: 40px;
    }

    /* Fallback Touch Area */
    .touch-control-area {
      width: 100%; height: 120px;
      background: var(--md-sys-color-surface-container-high);
      border-radius: var(--md-sys-shape-corner-medium);
      display: flex; align-items: center; justify-content: center;
      touch-action: none; position: relative;
    }
    .touch-control-thumb {
      width: 48px; height: 48px;
      background: var(--md-sys-color-primary);
      border-radius: 50%; position: absolute;
      box-shadow: var(--md-sys-elevation-2);
    }
    
    /* Permission Button */
    #gyro-perm-btn {
      margin-top: 16px;
    }
    :root {
      --md-sys-color-primary:             #D0BCFF;
      --md-sys-color-on-primary:          #381E72;
      --md-sys-color-primary-container:   #4F378B;
      --md-sys-color-on-primary-container:#EADDFF;
      --md-sys-color-secondary:             #CCC2DC;
      --md-sys-color-on-secondary:          #332D41;
      --md-sys-color-secondary-container:   #4A4458;
      --md-sys-color-on-secondary-container:#E8DEF8;
      --md-sys-color-tertiary:             #EFB8C8;
      --md-sys-color-on-tertiary:          #492532;
      --md-sys-color-tertiary-container:   #633B48;
      --md-sys-color-on-tertiary-container:#FFD8E4;
      --md-sys-color-error:             #F2B8B5;
      --md-sys-color-on-error:          #601410;
      --md-sys-color-error-container:   #8C1D18;
      --md-sys-color-on-error-container:#F9DEDC;
      --md-sys-color-surface:             #141218;
      --md-sys-color-on-surface:          #E6E0E9;
      --md-sys-color-surface-variant:     #49454F;
      --md-sys-color-on-surface-variant:  #CAC4D0;
      --md-sys-color-surface-dim:           #141218;
      --md-sys-color-surface-bright:        #3B383E;
      --md-sys-color-surface-container-lowest: #0F0D13;
      --md-sys-color-surface-container-low:    #1D1B20;
      --md-sys-color-surface-container:        #211F26;
      --md-sys-color-surface-container-high:   #2B2930;
      --md-sys-color-surface-container-highest:#36343B;
      --md-sys-color-outline:         #938F99;
      --md-sys-color-outline-variant: #49454F;
      --md-sys-color-inverse-surface:    #E6E0E9;
      --md-sys-color-inverse-on-surface: #322F35;
      --md-sys-color-inverse-primary:    #6750A4;
      --md-sys-color-shadow:     #000000;
      --md-sys-color-scrim:      #000000;
      --md-sys-state-hover-opacity:   0.08;
      --md-sys-state-focus-opacity:   0.12;
      --md-sys-state-pressed-opacity: 0.12;
      --md-sys-typescale-display-font:   'Google Sans', 'Noto Sans SC', sans-serif;
      --md-sys-typescale-headline-font:  'Google Sans', 'Noto Sans SC', sans-serif;
      --md-sys-typescale-title-font:     'Google Sans Text', 'Noto Sans SC', sans-serif;
      --md-sys-typescale-body-font:      'Google Sans Text', 'Noto Sans SC', sans-serif;
      --md-sys-typescale-label-font:     'Google Sans Text', 'Noto Sans SC', sans-serif;
      --md-sys-shape-corner-none:        0px;
      --md-sys-shape-corner-extra-small: 4px;
      --md-sys-shape-corner-small:       8px;
      --md-sys-shape-corner-medium:      12px;
      --md-sys-shape-corner-large:       16px;
      --md-sys-shape-corner-extra-large: 28px;
      --md-sys-shape-corner-full:        9999px;
      --md-sys-elevation-1: 0 1px 3px 1px rgba(0,0,0,0.15), 0 1px 2px 0 rgba(0,0,0,0.3);
      --md-sys-elevation-2: 0 2px 6px 2px rgba(0,0,0,0.15), 0 1px 2px 0 rgba(0,0,0,0.3);
      --md-sys-elevation-3: 0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px 0 rgba(0,0,0,0.3);
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%; min-height: 100vh; min-height: 100dvh;
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
      font-family: var(--md-sys-typescale-body-font);
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;
    }
    body {
      display: flex; flex-direction: column;
    }

    .material-symbols-rounded {
      font-family: 'Material Symbols Rounded';
      font-weight: normal; font-style: normal; font-size: 24px;
      line-height: 1; letter-spacing: normal;
      text-transform: none; display: inline-block;
      white-space: nowrap; word-wrap: normal;
      direction: ltr; font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
    }
    button, .md-tab, .md-assist-chip {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    /* â”€â”€ Top App Bar (M3 Center-aligned Small) â”€â”€â”€ */
    .top-app-bar {
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
      padding: 20px 16px 12px;
      padding-top: calc(20px + env(safe-area-inset-top));
      background: var(--md-sys-color-surface);
      /* Make it relative so it scrolls away, letting tabs stick to top */
      position: relative; z-index: 10;
    }
    .top-app-bar-title {
      font-family: var(--md-sys-typescale-title-font);
      font-size: 22px; font-weight: 400;
      color: var(--md-sys-color-on-surface);
      display: flex; align-items: center; gap: 8px;
    }
    .top-app-bar-title .material-symbols-rounded {
      font-size: 28px; color: var(--md-sys-color-primary);
    }
    .top-app-bar-subtitle {
      text-align: center; margin-top: 4px;
      font-family: var(--md-sys-typescale-body-font);
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
    }

    /* â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      flex: 1; display: flex; flex-direction: column;
      padding: 16px 20px 24px; gap: 20px;
      padding-bottom: calc(24px + env(safe-area-inset-bottom));
    }

    /* â”€â”€ Input Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-section {
      display: flex; flex-direction: column; gap: 12px;
    }
    .input-supporting-text {
      font-family: var(--md-sys-typescale-body-font);
      font-size: 14px;
      color: var(--md-sys-color-on-surface-variant);
      padding: 0 4px;
    }
    .input-supporting-text .material-symbols-rounded {
      font-size: 16px; vertical-align: -3px;
      color: var(--md-sys-color-primary);
    }

    /* â”€â”€ M3 Outlined Text Field â”€â”€â”€â”€â”€â”€â”€â”€ */
    .md-text-field {
      position: relative;
    }
    .md-text-field textarea {
      width: 100%; height: 100px; padding: 16px;
      border: 1px solid var(--md-sys-color-outline);
      border-radius: var(--md-sys-shape-corner-extra-small);
      background: transparent;
      color: var(--md-sys-color-on-surface);
      font-family: var(--md-sys-typescale-body-font);
      font-size: 16px; line-height: 1.5;
      resize: none; outline: none;
      caret-color: var(--md-sys-color-primary);
      transition: border-color 0.2s;
    }
    .md-text-field textarea::placeholder {
      color: var(--md-sys-color-on-surface-variant);
    }
    .md-text-field textarea:focus {
      border-color: var(--md-sys-color-primary);
      border-width: 2px;
      padding: 15px; /* compensate for 2px border */
    }
    .md-text-field .supporting-text {
      display: flex; justify-content: space-between;
      padding: 4px 16px 0;
      font-family: var(--md-sys-typescale-body-font);
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
    }

    /* â”€â”€ M3 Filled Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .md-filled-btn {
      width: 100%; height: 56px;
      border: none;
      border-radius: var(--md-sys-shape-corner-full);
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      font-family: var(--md-sys-typescale-label-font);
      font-size: 16px; font-weight: 500; letter-spacing: 0.1px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: box-shadow 0.2s, opacity 0.15s;
      box-shadow: none;
    }
    .md-filled-btn:hover {
      box-shadow: var(--md-sys-elevation-1);
    }
    .md-filled-btn:active {
      box-shadow: none;
    }
    .md-filled-btn:disabled {
      background: rgba(230,224,233,0.12);
      color: rgba(230,224,233,0.38);
      cursor: not-allowed;
      box-shadow: none;
    }
    .md-filled-btn .material-symbols-rounded { font-size: 18px; }

    /* â”€â”€ M3 Snackbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .md-snackbar {
      position: fixed; bottom: 24px; left: 16px; right: 16px;
      padding: 0 16px; min-height: 48px;
      background: var(--md-sys-color-inverse-surface);
      color: var(--md-sys-color-inverse-on-surface);
      border-radius: var(--md-sys-shape-corner-extra-small);
      font-family: var(--md-sys-typescale-body-font);
      font-size: 14px; font-weight: 400;
      display: flex; align-items: center;
      box-shadow: var(--md-sys-elevation-3);
      transform: translateY(80px);
      opacity: 0;
      transition: transform 0.3s cubic-bezier(0, 0, 0, 1), opacity 0.3s;
      z-index: 100; pointer-events: none;
    }
    .md-snackbar.show {
      transform: translateY(0); opacity: 1;
      pointer-events: auto;
    }
    .md-snackbar.error {
      background: var(--md-sys-color-error-container);
      color: var(--md-sys-color-on-error-container);
    }

    /* â”€â”€ M3 Assist Chips (Suggestion Chips) â”€â”€ */
    .chips-section {
      display: flex; flex-direction: column; gap: 10px;
    }
    .chips-section-title {
      font-family: var(--md-sys-typescale-label-font);
      font-size: 12px; font-weight: 500;
      letter-spacing: 0.5px; text-transform: uppercase;
      color: var(--md-sys-color-on-surface-variant);
    }
    .chips-row {
      display: flex; flex-wrap: wrap; gap: 8px;
    }
    .md-assist-chip {
      height: auto; min-height: 44px; padding: 6px 16px;
      border: 1px solid var(--md-sys-color-outline);
      border-radius: var(--md-sys-shape-corner-small);
      background: transparent;
      color: var(--md-sys-color-on-surface);
      font-family: var(--md-sys-typescale-label-font);
      font-size: 14px; font-weight: 500; letter-spacing: 0.1px;
      cursor: pointer;
      display: inline-flex; align-items: center; gap: 8px;
      transition: background 0.15s;
    }
    .md-assist-chip:hover {
      background: rgba(230,224,233, var(--md-sys-state-hover-opacity));
    }
    .md-assist-chip:active {
      background: rgba(230,224,233, var(--md-sys-state-pressed-opacity));
    }
    .md-assist-chip .material-symbols-rounded { font-size: 18px; }

    /* â”€â”€ Status Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-bar {
      display: flex; justify-content: center; align-items: center; gap: 12px;
      padding: 8px 0;
    }
    .status-indicator {
      display: inline-flex; align-items: center; gap: 6px;
      font-family: var(--md-sys-typescale-label-font);
      font-size: 12px; font-weight: 500;
      color: var(--md-sys-color-on-surface-variant);
      padding: 0 12px; height: 32px;
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: var(--md-sys-shape-corner-small);
    }
    .status-dot {
      width: 6px; height: 6px; border-radius: var(--md-sys-shape-corner-full);
      background: var(--md-sys-color-tertiary);
    }
    .status-dot.disconnected { background: var(--md-sys-color-error); }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer {
      text-align: center; padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      font-family: var(--md-sys-typescale-body-font);
      font-size: 12px;
      color: var(--md-sys-color-outline);
    }

    /* â”€â”€ Spinner (M3-style in button) â”€â”€ */
    .md-spinner {
      display: inline-block; width: 18px; height: 18px;
      border: 2.5px solid transparent;
      border-top-color: currentColor;
      border-radius: var(--md-sys-shape-corner-full);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header class="top-app-bar">
    <div>
      <div class="top-app-bar-title">
        <span class="material-symbols-rounded">music_note</span>
        Vibe Cod'in Pie
      </div>
    </div>
  </header>

  <!-- M3 Tabs -->
  <div class="md-tabs">
    <button class="md-tab active" data-tab="prompt">
      <span class="material-symbols-rounded md-tab-icon">edit_note</span>
      åˆ›ä½œ
      <span class="md-tab-indicator"></span>
    </button>
    <button class="md-tab" data-tab="control">
      <span class="material-symbols-rounded md-tab-icon">tune</span>
      æ§åˆ¶
      <span class="md-tab-indicator"></span>
    </button>
  </div>

  <main class="main">
    <!-- Prompt Section -->
    <div id="prompt-section">
      <!-- Input Section -->
      <section class="input-section">
        <div class="input-supporting-text">
          å‘Šè¯‰ AI ä½ æƒ³è¦ä»€ä¹ˆæ ·çš„éŸ³ä¹
          <span class="material-symbols-rounded">auto_awesome</span>
        </div>
        <div class="md-text-field">
          <textarea
            id="prompt-input"
            placeholder="ä¾‹å¦‚ï¼šåŠ ä¸€äº› lo-fi é¼“ç‚¹ã€è®©è´æ–¯æ›´æ·±æ²‰â€¦"
            maxlength="200"
          ></textarea>
          <div class="supporting-text">
            <span></span>
            <span><span id="char-count">0</span>/200</span>
          </div>
        </div>
        <button class="md-filled-btn" id="submit-btn">
          <span class="material-symbols-rounded">send</span>
          æäº¤
        </button>
      </section>

      <!-- Suggestion Chips -->
      <section class="chips-section">
        <div class="chips-section-title">è¯•è¯•è¿™äº›</div>
        <div class="chips-row">
          <button class="md-assist-chip" data-prompt="åŠ ä¸€äº› 808 é¼“ç‚¹">
            <span class="material-symbols-rounded">drum</span> 808 é¼“
          </button>
          <button class="md-assist-chip" data-prompt="è®©éŸ³ä¹æ›´æœ‰å¾‹åŠ¨æ„Ÿ">
            <span class="material-symbols-rounded">trending_up</span> æ›´æœ‰å¾‹åŠ¨
          </button>
          <button class="md-assist-chip" data-prompt="æ¢æˆçˆµå£«é£æ ¼çš„å’Œå¼¦">
            <span class="material-symbols-rounded">piano</span> çˆµå£«å’Œå¼¦
          </button>
          <button class="md-assist-chip" data-prompt="åŠ ä¸€äº›å»¶è¿Ÿæ•ˆæœ">
            <span class="material-symbols-rounded">blur_on</span> å»¶è¿Ÿæ•ˆæœ
          </button>
          <button class="md-assist-chip" data-prompt="è®©èŠ‚å¥å¿«ä¸€ç‚¹">
            <span class="material-symbols-rounded">speed</span> åŠ é€ŸèŠ‚å¥
          </button>
          <button class="md-assist-chip" data-prompt="æ¥ç‚¹ lo-fi æ„Ÿè§‰">
            <span class="material-symbols-rounded">nightlight</span> Lo-fi
          </button>
          <button class="md-assist-chip" data-prompt="åŠ ä¸€ä¸ªç”µå­ç¶éŸ³">
            <span class="material-symbols-rounded">electric_bolt</span> ç”µå­ç¶éŸ³
          </button>
          <button class="md-assist-chip" data-prompt="æŠŠè´æ–¯æ¢æˆæ–¹æ³¢">
            <span class="material-symbols-rounded">graphic_eq</span> æ–¹æ³¢è´æ–¯
          </button>
        </div>
      </section>
    </div>

    <!-- Slider Control Section -->
    <div id="slider-section">
      <div id="slider-cards" class="slider-card-container">
        <!-- Sliders injected here -->
      </div>
      <div id="no-sliders" class="no-sliders-msg">
        å½“å‰æ²¡æœ‰å¯æ§åˆ¶çš„æ»‘å—<br>è¯·ç­‰å¾… Master åˆ›å»º
      </div>
      
      <button id="gyro-perm-btn" class="md-filled-btn" style="display:none; width:auto; padding:0 32px;">
        <span class="material-symbols-rounded">screen_rotation</span>
        å¯ç”¨ä½“æ„Ÿæ§åˆ¶
      </button>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-indicator">
        <span class="status-dot disconnected" id="ws-dot"></span>
        é˜Ÿåˆ—: <strong id="queue-num">0</strong> æ¡å¾…å¤„ç†
      </div>
    </div>
  </main>

  <footer class="footer">
    Powered by Strudel + DeepSeek Â· ShanghaiTech GeekPie
  </footer>

  <!-- Snackbar -->
  <div class="md-snackbar" id="snackbar"></div>

  <script>
    // â”€â”€ Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const input = document.getElementById('prompt-input');
    const submitBtn = document.getElementById('submit-btn');
    const snackbar = document.getElementById('snackbar');
    const charCount = document.getElementById('char-count');
    const queueNum = document.getElementById('queue-num');
    const wsDot = document.getElementById('ws-dot');
    const chips = document.querySelectorAll('.md-assist-chip');
    
    // Tabs & Sections
    const tabs = document.querySelectorAll('.md-tab');
    const promptSection = document.getElementById('prompt-section');
    const sliderSection = document.getElementById('slider-section');
    const sliderCardsContainer = document.getElementById('slider-cards');
    const noSlidersMsg = document.getElementById('no-sliders');
    const gyroPermBtn = document.getElementById('gyro-perm-btn');
    
    // â”€â”€ Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    let sessionId = localStorage.getItem('vcp-session');
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      localStorage.setItem('vcp-session', sessionId);
    }

    // â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let ws = null;
    let cooldownTimer = null;
    let activeSliders = [];
    let currentControlId = null;
    let gyroEnabled = false;
    let gyroForce = 0;
    
    // Throttle control updates
    let lastControlSent = 0;
    const CONTROL_THROTTLE_MS = 100;

    function connectWS() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      let wsHost;
      
      // If we are on Vite dev server (usually 5173), connect to backend port 3000 explicitly
      if (location.port === '5173') {
        wsHost = location.hostname + ':3000';
      } else {
        // Otherwise assume we are served by the backend (same origin)
        wsHost = location.host;
      }

      const wsUrl = `${protocol}//${wsHost}/ws?type=mobile&session=${sessionId}`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        wsDot.classList.remove('disconnected');
        console.log('Connected');
      };

      ws.onmessage = (e) => {
        try {
          const msg = JSON.parse(e.data);
          handleMessage(msg);
        } catch (err) {
          console.error(err);
        }
      };

      ws.onclose = () => {
        wsDot.classList.add('disconnected');
        setTimeout(connectWS, 3000);
      };

      ws.onerror = () => {
        wsDot.classList.add('disconnected');
      };
    }

    function handleMessage(msg) {
      // Always reset loading state on response to submission (queued, error, rate_limited)
      if (['queued', 'error', 'rate_limited'].includes(msg.type)) {
        setLoading(false);
      }

      switch (msg.type) {
        case 'init':
          queueNum.textContent = msg.queueSize || 0;
          if (msg.sliders) updateSliders(msg.sliders);
          break;

        case 'available_sliders':
          updateSliders(msg.sliders);
          break;

        case 'queued':
          showSnackbar(`âœ… å·²æäº¤ï¼ä½ åœ¨ç¬¬ ${msg.position} ä½`);
          break;

        case 'processing':
          showSnackbar(msg.message || 'ğŸ¤– AI æ­£åœ¨ç”Ÿæˆ...');
          break;

        case 'rate_limited':
          showSnackbar(`â³ è¯·ç­‰å¾… ${msg.waitSeconds} ç§’åå†æäº¤`);
          startCooldown(msg.waitSeconds);
          break;

        case 'prompt_applied':
          showSnackbar(msg.message || 'ğŸµ ä½ çš„ä¿®æ”¹å·²ç”Ÿæ•ˆï¼');
          break;

        case 'generation_failed':
          showSnackbar(msg.message || 'ä»£ç ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ¢ä¸ªè¯´æ³•', true);
          break;

        case 'queue_update':
          queueNum.textContent = msg.queueSize || 0;
          break;

        case 'slider_value_update':
          updateSliderValue(msg.id, msg.value);
          break;

        case 'force_info':
          updateForceInfo(msg.sliders);
          break;

        case 'error':
          showSnackbar(msg.message, true);
          break;
      }
    }
    
    // â”€â”€ Tab Switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function activateTab(tab) {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      const mode = tab.dataset.tab;
      if (mode === 'prompt') {
        promptSection.style.display = 'block';
        sliderSection.style.display = 'none';
        stopControl();
      } else {
        promptSection.style.display = 'none';
        sliderSection.style.display = 'flex';
        checkGyroPermission();
        if (activeSliders.length > 0 && !currentControlId) {
           focusSlider(activeSliders[0].id);
        }
      }
    }
    
    tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        activateTab(tab);
      });
      tab.addEventListener('touchend', (e) => {
        e.preventDefault();
        activateTab(tab);
      });
    });

    // â”€â”€ Slider Control Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateSliders(sliders) {
      activeSliders = sliders || [];
      sliderCardsContainer.innerHTML = '';
      
      if (activeSliders.length === 0) {
        noSlidersMsg.style.display = 'block';
        return;
      }
      noSlidersMsg.style.display = 'none';
      
      activeSliders.forEach((s, idx) => {
        const card = document.createElement('div');
        card.className = 'slider-card';
        card.dataset.id = s.id;
        
        card.innerHTML = `
          <div class="slider-name">${escapeHtml(s.name)}</div>
          <div class="slider-value-display">${parseFloat(s.value).toFixed(2)}</div>
          
          <div class="force-visualizer">
            <div class="force-center-mark"></div>
            <div class="force-bar" style="width: 0%; left: 50%;"></div>
          </div>
          
          <div class="touch-control-area">
             <div class="touch-control-thumb" style="left: calc(50% - 24px);"></div>
          </div>
          
          <div class="control-hint">
            <span class="material-symbols-rounded gyro-icon">screen_rotation</span>
            <span>å·¦å³å€¾æ–œæ‰‹æœºæ¥æ§åˆ¶</span>
          </div>
        `;
        
        sliderCardsContainer.appendChild(card);
        
        // Touch fallback logic
        const touchArea = card.querySelector('.touch-control-area');
        const thumb = card.querySelector('.touch-control-thumb');
        let startX = 0;
        
        touchArea.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX;
          currentControlId = s.id;
          highlightCard(s.id);
          e.preventDefault();
        });
        
        touchArea.addEventListener('touchmove', (e) => {
           if (currentControlId !== s.id) return;
           const x = e.touches[0].clientX;
           const rect = touchArea.getBoundingClientRect();
           const center = rect.width / 2;
           const offsetX = x - rect.left - center;
           
           // Normalize -1 to 1 based on half width
           let force = offsetX / (rect.width / 2);
           force = Math.max(-1, Math.min(1, force));
           
           // Update Visuals
           updateForceVisuals(card, force);
           
           // Send
           sendControlForce(force);
           e.preventDefault();
        });
        
        touchArea.addEventListener('touchend', () => {
           updateForceVisuals(card, 0);
           sendControlForce(0);
           // Don't clear currentControlId immediately to allow gyro to take over
        });
      });
      
      // Setup Scroll Observer to detect active card
      setupScrollObserver();
    }

    function updateSliderValue(id, value) {
      const card = document.querySelector(`.slider-card[data-id="${CSS.escape(id)}"]`);
      if (!card) return;
      const display = card.querySelector('.slider-value-display');
      if (display) display.textContent = parseFloat(value).toFixed(2);
    }

    function updateForceInfo(sliders) {
      if (!sliders) return;
      for (const s of sliders) {
        const card = document.querySelector(`.slider-card[data-id="${CSS.escape(s.id)}"]`);
        if (!card) continue;
        // Update force visualizer bar
        updateForceVisuals(card, s.netForce || 0);
        // Update participant count in hint
        const hint = card.querySelector('.control-hint span:last-child');
        if (hint && s.participants > 0) {
          hint.textContent = `${s.participants} äººå‚ä¸ä¸­`;
        } else if (hint) {
          hint.textContent = 'å·¦å³å€¾æ–œæ‰‹æœºæ¥æ§åˆ¶';
        }
      }
    }

    function setupScrollObserver() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const id = entry.target.dataset.id;
            focusSlider(id);
          }
        });
      }, { root: sliderCardsContainer, threshold: 0.6 });
      
      document.querySelectorAll('.slider-card').forEach(c => observer.observe(c));
    }
    
    function focusSlider(id) {
      currentControlId = id;
      highlightCard(id);
    }
    
    function highlightCard(id) {
      document.querySelectorAll('.slider-card').forEach(c => {
         c.classList.toggle('active-control', c.dataset.id === id);
      });
    }
    
    function updateForceVisuals(card, force) {
       const bar = card.querySelector('.force-bar');
       const thumb = card.querySelector('.touch-control-thumb');
       
       // Force is -1 to 1
       const width = Math.abs(force) * 50; // 0 to 50%
       const left = force < 0 ? (50 - width) : 50;
       
       bar.style.width = `${width}%`;
       bar.style.left = `${left}%`;
       
       // Move thumb
       // Container width approx 100% - padding?
       // Just visual approximation for thumb
       if (thumb) {
           const offset = force * 40; // +/- 40px
           thumb.style.transform = `translateX(${offset}px)`;
       }
       
       // Haptics on threshold
       if (Math.abs(force) > 0.9 && navigator.vibrate) {
          // navigator.vibrate(5); // subtle tick
       }
    }

    // â”€â”€ Gyroscope Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function checkGyroPermission() {
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        gyroPermBtn.style.display = 'inline-flex';
        gyroPermBtn.onclick = () => {
          DeviceOrientationEvent.requestPermission()
            .then(response => {
              if (response == 'granted') {
                enableGyro();
                gyroPermBtn.style.display = 'none';
              }
            })
            .catch(console.error);
        };
      } else {
        enableGyro(); // Android or older iOS
      }
    }
    
    function enableGyro() {
      if (gyroEnabled) return;
      gyroEnabled = true;
      window.addEventListener('deviceorientation', handleOrientation);
    }
    
    function handleOrientation(event) {
      if (!currentControlId || sliderSection.style.display === 'none') return;
      
      // Gamma is left/right tilt (-90 to 90)
      // We want range approx -45 to 45 mapping to -1 to 1
      let gamma = event.gamma;
      
      // Fix for some devices flipping range
      if (gamma > 90) gamma = 90;
      if (gamma < -90) gamma = -90;
      
      // Deadzone +/- 5
      if (Math.abs(gamma) < 5) gamma = 0;
      else gamma = gamma - (Math.sign(gamma) * 5);
      
      // Scale: 30 degrees = full force
      let force = gamma / 30;
      force = Math.max(-1, Math.min(1, force));
      
      // Only update if no touch interaction active?
      // Assuming touch overrides gyro.
      // We can update visuals on the active card
      const card = document.querySelector(`.slider-card[data-id="${currentControlId}"]`);
      if (card) {
         updateForceVisuals(card, force);
         sendControlForce(force);
      }
    }
    
    function sendControlForce(force) {
      const now = Date.now();
      if (now - lastControlSent < CONTROL_THROTTLE_MS && force !== 0) return;
      
      if (ws && ws.readyState === WebSocket.OPEN && currentControlId) {
        ws.send(JSON.stringify({
           type: 'control_slider',
           id: currentControlId,
           force: parseFloat(force.toFixed(3))
        }));
        lastControlSent = now;
      }
    }
    
    function stopControl() {
      if (ws && ws.readyState === WebSocket.OPEN) {
         ws.send(JSON.stringify({
            type: 'stop_control',
            all: true
         }));
      }
      currentControlId = null;
    }

    // â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    submitBtn.addEventListener('click', () => {
      const prompt = input.value.trim();
      if (!prompt) return;
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showSnackbar('æœªè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·åˆ·æ–°é¡µé¢', true);
        return;
      }

      ws.send(JSON.stringify({ type: 'submit_prompt', prompt }));
      
      // UX: Clear input immediately but show loading state
      input.value = '';
      charCount.textContent = '0';
      setLoading(true);
    });
    
    function setLoading(isLoading) {
      if (isLoading) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="md-spinner"></span> æäº¤ä¸­â€¦`;
      } else {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span class="material-symbols-rounded">send</span> æäº¤';
      }
    }

    // â”€â”€ Char counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    input.addEventListener('input', () => {
      charCount.textContent = input.value.length;
    });

    // â”€â”€ Suggestion chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyPrompt(text) {
      input.value = text;
      charCount.textContent = input.value.length;
      input.focus();
      if (input.setSelectionRange) {
        const end = input.value.length;
        input.setSelectionRange(end, end);
      }
    }
    
    chips.forEach(chip => {
      chip.addEventListener('click', (e) => {
        e.preventDefault();
        applyPrompt(chip.dataset.prompt);
      });
      chip.addEventListener('touchend', (e) => {
        e.preventDefault();
        applyPrompt(chip.dataset.prompt);
      });
    });

    // â”€â”€ Snackbar (M3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let snackbarTimeout = null;
    function showSnackbar(text, isError) {
      clearTimeout(snackbarTimeout);
      snackbar.textContent = text;
      snackbar.className = 'md-snackbar show' + (isError ? ' error' : '');
      snackbarTimeout = setTimeout(() => {
        snackbar.className = 'md-snackbar';
      }, 4000);
    }

    // â”€â”€ Cooldown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startCooldown(seconds) {
      submitBtn.disabled = true;
      let remaining = seconds;
      submitBtn.innerHTML = `<span class="md-spinner"></span> ç­‰å¾… ${remaining}s`;

      clearInterval(cooldownTimer);
      cooldownTimer = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          clearInterval(cooldownTimer);
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span class="material-symbols-rounded">send</span> æäº¤';
        } else {
          submitBtn.innerHTML = `<span class="md-spinner"></span> ç­‰å¾… ${remaining}s`;
        }
      }, 1000);
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    connectWS();
  </script>
</body>
</html>
